HTSDIR=./htslib
HTSLIB_LIBDIR="${R_PACKAGE_DIR}/lib${R_ARCH}"
HTSLIB_INCLUDEDIR="${R_PACKAGE_DIR}/include"

R_CC=`"${R_HOME}/bin/R" CMD config CC`
R_CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
R_LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`
R_CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
R_CPP=`"${R_HOME}/bin/R" CMD config CPP`

.PHONY: all clean Rinstall

all: $(SHLIB)

$(SHLIB): Rhtslib.o

Rhtslib.o: Rinstall

# always run so we never skip copying library & headers into
# destination; otherwise, a user could R CMD INSTALL Rhtslib, then
# subsequently remove the package, then try R CMD INSTALL Rhtslib
# again--in which case the library and headers would not be
# reinstalled
Rinstall: $(HTSDIR)/libhts.a
	@mkdir -p $(HTSLIB_LIBDIR) $(HTSLIB_INCLUDEDIR)
	cp $(HTSDIR)/libhts.a $(HTSLIB_LIBDIR)
	cp $(HTSLIB_PUBLIC_HEADERS) $(HTSLIB_INCLUDEDIR)

## yes, need to 'cd' into $(HTSDIR) for each command
$(HTSDIR)/libhts.a:
        ## run ./htslib/configure
	cd $(HTSDIR)/ && ./configure --disable-dependency-tracking \
	CC="${R_CC}" CFLAGS="${R_CFLAGS}" LDFLAGS="${R_LDFLAGS}" \
	CPPFLAGS="${R_CPPFLAGS}" CPP="${R_CPP}"
	cd $(HTSDIR)/ && $(MAKE)

include $(HTSDIR)/htslib.mk

## files generated by configure
CONFIGURE_GEN_FILES= \
    $(HTSDIR)/config.log $(HTSDIR)/config.h $(HTSDIR)/config.status \
    $(HTSDIR)/stamp-h1 $(HTSDIR)/Makefile $(HTSDIR)/lib/Makefile \
    $(HTSDIR)/test/Makefile

## removing configure-generated files MUST come after running
## clean-recursive in HTSDIR, since said recursive Makefiles specify
## what to clean
clean:
	rm -f *.o *.a
	cd $(HTSDIR) && $(MAKE) distclean-recursive && cd ..

shlib-clean: clean
